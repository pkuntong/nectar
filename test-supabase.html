<!DOCTYPE html>
<html>
<head>
    <title>Supabase Connection Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #065f46; }
        .error { background: #991b1b; }
        .info { background: #1e40af; }
        pre { background: #000; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase Connection Test</h1>
    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function runTests() {
            // Test 1: Check environment variables
            log('ğŸ“ Step 1: Checking environment variables...', 'info');
            const url = 'https://getekqgyhwmbhyznamli.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdldGVrcWd5aHdtYmh5em5hbWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NzMxMjAsImV4cCI6MjA4MDA0OTEyMH0.Tmz6-F-Twmrry4htcu5R70slQdAxXDjjrTDTKm0kGZg';

            log(`âœ… URL: ${url}`, 'success');
            log(`âœ… Key: ${key.substring(0, 30)}...`, 'success');

            // Test 2: Load Supabase client
            log('ğŸ“ Step 2: Loading Supabase client...', 'info');
            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                document.head.appendChild(script);

                await new Promise((resolve) => {
                    script.onload = resolve;
                });

                log('âœ… Supabase client loaded', 'success');
            } catch (error) {
                log(`âŒ Failed to load Supabase client: ${error.message}`, 'error');
                return;
            }

            // Test 3: Create client
            log('ğŸ“ Step 3: Creating Supabase client...', 'info');
            let supabase;
            try {
                supabase = window.supabase.createClient(url, key);
                log('âœ… Client created', 'success');
            } catch (error) {
                log(`âŒ Failed to create client: ${error.message}`, 'error');
                return;
            }

            // Test 4: Check auth connection
            log('ğŸ“ Step 4: Testing auth connection...', 'info');
            try {
                const { data, error } = await supabase.auth.getSession();
                if (error) {
                    log(`âš ï¸  Auth error: ${error.message}`, 'error');
                } else {
                    log('âœ… Auth connection working', 'success');
                }
            } catch (error) {
                log(`âŒ Auth test failed: ${error.message}`, 'error');
            }

            // Test 5: Check if user_profiles table exists
            log('ğŸ“ Step 5: Checking if user_profiles table exists...', 'info');
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "public.user_profiles" does not exist')) {
                        log('âŒ DATABASE NOT SET UP: user_profiles table does not exist!', 'error');
                        log('ğŸ’¡ You need to run the migration SQL in Supabase dashboard', 'info');
                        log('<pre>1. Go to: https://supabase.com/dashboard/project/getekqgyhwmbhyznamli\n2. Click SQL Editor â†’ New Query\n3. Copy/paste contents from: supabase/migrations/20241130_initial_schema.sql\n4. Click Run</pre>', 'info');
                    } else {
                        log(`âŒ Database error: ${error.message}`, 'error');
                        log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                    }
                } else {
                    log('âœ… user_profiles table exists!', 'success');
                    log('âœ… Database is set up correctly', 'success');
                }
            } catch (error) {
                log(`âŒ Table check failed: ${error.message}`, 'error');
                log(`<pre>${error.stack}</pre>`, 'error');
            }

            // Test 6: Check if subscriptions table exists
            log('ğŸ“ Step 6: Checking if subscriptions table exists...', 'info');
            try {
                const { data, error } = await supabase
                    .from('subscriptions')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "public.subscriptions" does not exist')) {
                        log('âŒ subscriptions table does not exist!', 'error');
                    } else {
                        log(`âš ï¸  Error: ${error.message}`, 'error');
                    }
                } else {
                    log('âœ… subscriptions table exists!', 'success');
                }
            } catch (error) {
                log(`âŒ Table check failed: ${error.message}`, 'error');
            }

            log('', 'info');
            log('ğŸ¯ SUMMARY:', 'info');
            log('If you see "user_profiles table does not exist" above, you MUST run the migration SQL.', 'info');
            log('If all tests pass âœ…, your database is ready!', 'success');
        }

        // Run tests after a short delay
        setTimeout(runTests, 100);
    </script>
</body>
</html>
